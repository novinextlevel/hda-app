<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halodoc Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, where, serverTimestamp, increment, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword,
            getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, where, serverTimestamp, increment, writeBatch, getDocs
        };
    </script>
    
    <!-- React Application -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { 
            initializeApp, getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword,
            getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, where, serverTimestamp, increment, writeBatch, getDocs
        } = window.firebase;

        // --- Icon Components (using inline SVG) ---
        const Icon = ({ children, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const AcademyLogo = ({className}) => <svg className={className} viewBox="0 0 234 40" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.9888 21.3101C19.2644 21.3068 18.6496 20.7836 18.5583 20.0632C18.467 19.3428 18.919 18.6676 19.642 18.5996C19.7214 18.5922 19.8008 18.5885 19.8802 18.5885C20.6231 18.5885 21.2312 19.1414 21.3121 19.8641C21.3963 20.6133 20.7956 21.2662 20.0427 21.3101H19.9888ZM23.4983 11.5947C23.1167 11.5947 22.8093 11.2873 22.8093 10.9057V4.31885C22.8093 3.93726 23.1167 3.62988 23.4983 3.62988C23.8799 3.62988 24.1873 3.93726 24.1873 4.31885V10.9057C24.1873 11.2873 23.8799 11.5947 23.4983 11.5947ZM23.5015 15.6318C21.3323 15.6318 19.5696 17.3945 19.5696 19.5635C19.5696 21.7324 21.3323 23.4951 23.5015 23.4951C25.6704 23.4951 27.4331 21.7324 27.4331 19.5635C27.4331 17.3945 25.6704 15.6318 23.5015 15.6318ZM23.5015 22.1138C22.0969 22.1138 20.9475 20.9644 20.9475 19.5598C20.9475 18.1553 22.0969 17.0059 23.5015 17.0059C24.906 17.0059 26.0554 18.1553 26.0554 19.5598C26.0554 20.9644 24.906 22.1138 23.5015 22.1138ZM13.8871 11.4536C13.8044 11.2388 13.5659 11.1353 13.3441 11.218L13.1611 11.2825L6.50378 13.6294C2.9696 14.8696 0.354004 18.2588 0.354004 22.1123V27.4897C0.354004 28.1182 0.857666 28.6218 1.48621 28.6218C2.11475 28.6218 2.61841 28.1182 2.61841 27.4897V22.1123C2.61841 19.2319 4.60535 16.6987 7.42957 15.7197L13.8241 13.4375C14.0459 13.3547 14.1563 13.1162 14.0736 12.8945L13.8871 12.3789V11.4536ZM20.0427 21.3101C20.0322 21.3101 20.0217 21.3101 20.0112 21.3101C19.9976 21.3101 19.9804 21.3068 19.9668 21.3068H19.9888L20.0427 21.3101Z" fill="white"/><path d="M49.6381 27.8789H47.5356V16.0938H49.6381V27.8789ZM48.5868 14.4531C47.7475 14.4531 47.0707 13.7764 47.0707 12.937C47.0707 12.0977 47.7475 11.4209 48.5868 11.4209C49.4262 11.4209 50.1029 12.0977 50.1029 12.937C50.1029 13.7764 49.4262 14.4531 48.5868 14.4531Z" fill="white"/><path d="M54.1283 16.0938V27.8789H52.0258V16.0938H54.1283Z" fill="white"/><path d="M68.8093 18.2812C68.8093 16.0156 67.5788 15.1172 65.5925 15.1172C63.6062 15.1172 62.3757 16.0156 62.3757 18.2812C62.3757 20.5469 63.6062 21.4453 65.5925 21.4453C67.5788 21.4453 68.8093 20.5469 68.8093 18.2812ZM66.7653 18.2812C66.7653 19.8633 66.278 20.4766 65.5925 20.4766C64.907 20.4766 64.4196 19.8633 64.4196 18.2812C64.4196 16.6992 64.907 16.0859 65.5925 16.0859C66.278 16.0859 66.7653 16.6992 66.7653 18.2812Z" fill="white"/><path d="M72.2351 16.0938V27.8789H70.1326V16.0938H72.2351Z" fill="white"/><path d="M82.2663 16.0938H84.3688V27.8789H82.2663V16.0938ZM83.3175 14.4531C82.4782 14.4531 81.8015 13.7764 81.8015 12.937C81.8015 12.0977 82.4782 11.4209 83.3175 11.4209C84.1569 11.4209 84.8337 12.0977 84.8337 12.937C84.8337 13.7764 84.1569 14.4531 83.3175 14.4531Z" fill="white"/><path d="M96.7901 18.2812C96.7901 16.0156 95.5596 15.1172 93.5733 15.1172C91.587 15.1172 90.3565 16.0156 90.3565 18.2812C90.3565 20.5469 91.587 21.4453 93.5733 21.4453C95.5596 21.4453 96.7901 20.5469 96.7901 18.2812ZM94.7461 18.2812C94.7461 19.8633 94.2588 20.4766 93.5733 20.4766C92.8878 20.4766 92.3995 19.8633 92.3995 18.2812C92.3995 16.6992 92.8878 16.0859 93.5733 16.0859C94.2588 16.0859 94.7461 16.6992 94.7461 18.2812Z" fill="white"/><path d="M107.571 18.2812C107.571 16.0156 106.341 15.1172 104.354 15.1172C102.368 15.1172 101.137 16.0156 101.137 18.2812C101.137 20.5469 102.368 21.4453 104.354 21.4453C106.341 21.4453 107.571 20.5469 107.571 18.2812ZM105.527 18.2812C105.527 19.8633 105.04 20.4766 104.354 20.4766C103.669 20.4766 103.181 19.8633 103.181 18.2812C103.181 16.6992 103.669 16.0859 104.354 16.0859C105.04 16.0859 105.527 16.6992 105.527 18.2812Z" fill="white"/><path d="M117.936 21.2461C117.936 21.2461 117.13 21.8438 116.142 21.8438C114.717 21.8438 114.336 21.0625 114.336 20.1484V16.0938H112.233V20.4102C112.233 22.8125 114.102 23.9453 116.205 23.9453C117.811 23.9453 118.896 23.1484 118.896 23.1484V21.2461H117.936Z" fill="white"/><path d="M127.359 18.2812C127.359 16.0156 126.128 15.1172 124.142 15.1172C122.156 15.1172 120.925 16.0156 120.925 18.2812C120.925 20.5469 122.156 21.4453 124.142 21.4453C126.128 21.4453 127.359 20.5469 127.359 18.2812ZM125.315 18.2812C125.315 19.8633 124.828 20.4766 124.142 20.4766C123.457 20.4766 122.969 19.8633 122.969 18.2812C122.969 16.6992 123.457 16.0859 124.142 16.0859C124.828 16.0859 125.315 16.6992 125.315 18.2812Z" fill="white"/><path d="M141.341 23.8047C142.147 23.8047 142.668 23.2383 142.668 22.5625V21.7812H142.603C142.115 22.6211 141.128 23.0117 140.223 23.0117C138.271 23.0117 137.339 21.8438 137.339 20.1484V16.0938H135.237V20.4102C135.237 22.8125 137.105 23.9453 139.208 23.9453C140.354 23.9453 141.097 23.4961 141.341 23.2383V23.8047Z" fill="white"/><path d="M153.308 18.2812C153.308 16.0156 152.077 15.1172 150.091 15.1172C148.105 15.1172 146.874 16.0156 146.874 18.2812C146.874 20.5469 148.105 21.4453 150.091 21.4453C152.077 21.4453 153.308 20.5469 153.308 18.2812ZM151.264 18.2812C151.264 19.8633 150.777 20.4766 150.091 20.4766C149.406 20.4766 148.918 19.8633 148.918 18.2812C148.918 16.6992 149.406 16.0859 150.091 16.0859C150.777 16.0859 151.264 16.6992 151.264 18.2812Z" fill="white"/><path d="M165.719 21.2461C165.719 21.2461 164.912 21.8438 163.924 21.8438C162.5 21.8438 162.119 21.0625 162.119 20.1484V16.0938H160.016V20.4102C160.016 22.8125 161.885 23.9453 163.988 23.9453C165.594 23.9453 166.678 23.1484 166.678 23.1484V21.2461H165.719Z" fill="white"/><path d="M174.966 16.0938V21.7148L170.899 16.0938H168.665V27.8789H170.767V22.2578L174.834 27.8789H177.069V16.0938H174.966Z" fill="white"/><path d="M187.643 18.2812C187.643 16.0156 186.412 15.1172 184.426 15.1172C182.44 15.1172 181.209 16.0156 181.209 18.2812C181.209 20.5469 182.44 21.4453 184.426 21.4453C186.412 21.4453 187.643 20.5469 187.643 18.2812ZM185.599 18.2812C185.599 19.8633 185.112 20.4766 184.426 20.4766C183.741 20.4766 183.253 19.8633 183.253 18.2812C183.253 16.6992 183.741 16.0859 184.426 16.0859C185.112 16.0859 185.599 16.6992 185.599 18.2812Z" fill="white"/><path d="M201.218 21.2461C201.218 21.2461 200.412 21.8438 199.424 21.8438C198 21.8438 197.619 21.0625 197.619 20.1484V16.0938H195.516V20.4102C195.516 22.8125 197.385 23.9453 199.488 23.9453C201.094 23.9453 202.178 23.1484 202.178 23.1484V21.2461H201.218Z" fill="white"/><path d="M211.75 23.8047C212.556 23.8047 213.077 23.2383 213.077 22.5625V21.7812H213.012C212.524 22.6211 211.537 23.0117 210.632 23.0117C208.68 23.0117 207.748 21.8438 207.748 20.1484V16.0938H205.646V20.4102C205.646 22.8125 207.514 23.9453 209.617 23.9453C210.763 23.9453 211.506 23.4961 211.75 23.2383V23.8047Z" fill="white"/><path d="M222.186 16.0938L218.436 23.7422L216.799 23.7422L220.678 16.0938H222.186Z" fill="white"/><path d="M233.153 16.0938L229.403 23.7422L227.766 23.7422L231.645 16.0938H233.153Z" fill="white"/></svg>;
        
        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState('feed');
            
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
                    if (firebaseUser) {
                        setUser(firebaseUser);
                        const userDocRef = doc(db, "users", firebaseUser.uid);
                        const userDocSnap = await getDoc(userDocRef);
                        if (userDocSnap.exists()) {
                            setUserData({ ...userDocSnap.data(), isAdmin: firebaseUser.uid === ADMIN_UID });
                        } else {
                            setUserData(null);
                        }
                    } else {
                        setUser(null);
                        setUserData(null);
                    }
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (isLoading) { return <LoadingScreen />; }
            if (!user) { return <AuthScreen />; }
            if (user && !userData) { return <ProfileSetupScreen user={user} onProfileCreated={setUserData} />; }

            if (user && userData) {
                return (
                    <div className="container mx-auto max-w-4xl">
                        <Header user={user} userData={userData} />
                        <main className="p-4 pb-24">
                            {currentPage === 'feed' && <Feed user={user} userData={userData} />}
                            {currentPage === 'discussions' && <Discussions user={user} userData={userData} />}
                            {currentPage === 'leaderboard' && userData.isAdmin && <Leaderboard />}
                            {currentPage === 'points_history' && !userData.isAdmin && <PointsHistory user={user} />}
                            {currentPage === 'profile' && <Profile user={user} userData={userData} />}
                        </main>
                        <NavBar currentPage={currentPage} setCurrentPage={setCurrentPage} userData={userData}/>
                    </div>
                );
            }
            return <LoadingScreen message="Verifying connection..."/>;
        }

        function AuthScreen() {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');
                try { if (isLogin) { await signInWithEmailAndPassword(auth, email, password); } else { await createUserWithEmailAndPassword(auth, email, password); } } catch (err) { setError(err.message); } 
                finally { setIsLoading(false); }
            };
            return (<div className="min-h-screen flex items-center justify-center p-4"><div className="w-full max-w-md bg-white rounded-xl shadow-lg p-8"><div className="text-center mb-6"><AcademyLogo className="h-10 mx-auto" /></div><h2 className="text-xl font-bold text-center mb-4">{isLogin ? 'Login' : 'Register'}</h2>{error && <p className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">{error}</p>}<form onSubmit={handleSubmit} className="space-y-4"><div><label className="block text-sm font-medium">Email</label><input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full p-2 rounded-lg border" required /></div><div><label className="block text-sm font-medium">Password</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 rounded-lg border" required /></div><button type="submit" disabled={isLoading} className="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 disabled:bg-red-300">{isLoading ? 'Loading...' : (isLogin ? 'Login' : 'Register')}</button></form><div className="mt-4 text-center"><button onClick={() => setIsLogin(!isLogin)} className="text-sm text-red-600 hover:underline">{isLogin ? 'Need an account? Register' : 'Already have an account? Login'}</button></div></div></div>);
        }
        
        function LoadingScreen({ message = "Connecting to Halodoc Academy..." }) { return (<div className="flex flex-col items-center justify-center min-h-screen"><AcademyLogo className="h-16 animate-pulse" /><h1 className="mt-4 text-xl font-semibold text-red-700">{message}</h1></div>); }
        function ProfileSetupScreen({ user, onProfileCreated }) {
            const [displayName, setDisplayName] = useState('');
            const [profession, setProfession] = useState('');
            const [error, setError] = useState('');
            const [isSaving, setIsSaving] = useState(false);
            const handleSetup = async () => {
                if (!displayName.trim() || !profession) { setError("Please provide your name and select a profession."); return; }
                setIsSaving(true);
                const userProfile = { uid: user.uid, displayName, profession, points: 0, createdAt: serverTimestamp(), isAdmin: user.uid === ADMIN_UID };
                try { await setDoc(doc(db, "users", user.uid), userProfile); onProfileCreated({ ...userProfile, isAdmin: user.uid === ADMIN_UID }); } catch (err) { console.error("Error creating profile:", err); setError("Could not save profile. Please try again."); setIsSaving(false); }
            };
            return (<div className="min-h-screen flex items-center justify-center p-4"><div className="w-full max-w-md bg-white rounded-xl shadow-lg p-8"><div className="text-center mb-6"><BrainCircuit className="w-12 h-12 mx-auto text-red-500" /><h1 className="text-2xl font-bold text-gray-800 mt-2">Welcome to Halodoc Academy</h1><p className="text-gray-500">Let's set up your professional profile.</p></div>{error && <p className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">{error}</p>}<div className="space-y-6"><div><label htmlFor="displayName" className="block text-sm font-medium text-gray-700 mb-1">Full Name</label><input id="displayName" type="text" value={displayName} onChange={(e) => setDisplayName(e.target.value)} placeholder="e.g. Dr. Budi Santoso" className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" /></div><div><label htmlFor="profession" className="block text-sm font-medium text-gray-700 mb-1">Profession</label><select id="profession" value={profession} onChange={(e) => setProfession(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 bg-white"><option value="" disabled>Select your profession...</option>{PROFESSIONS.map(p => <option key={p} value={p}>{p}</option>)}</select></div></div><div className="mt-8"><button onClick={handleSetup} disabled={isSaving} className="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:bg-red-300 transition-colors">{isSaving ? "Saving..." : "Join Academy"}</button></div></div></div>);
        }
        function Header({ user, userData }) {
            return (<header className="bg-white shadow-sm sticky top-0 z-20 p-4 flex justify-between items-center"><div className="flex items-center space-x-3"><AcademyLogo className="h-8" /></div>{!userData.isAdmin && <div className="flex items-center space-x-2 bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full"><Award className="w-5 h-5" /><span className="font-semibold">{userData.points} Pts</span></div>}</header>);
        }
        function NavBar({ currentPage, setCurrentPage, userData }) { 
            let navItems = [
                { id: 'feed', label: 'Feed', icon: BookOpen }, 
                { id: 'discussions', label: 'Discussions', icon: MessageSquare }, 
                { id: 'profile', label: 'Profile', icon: User }
            ];
            if (userData.isAdmin) {
                navItems.splice(2, 0, { id: 'leaderboard', label: 'Leaderboard', icon: Award });
            } else {
                navItems.splice(2, 0, { id: 'points_history', label: 'My Points', icon: History });
            }
            return (<nav className="fixed bottom-0 left-0 right-0 bg-white shadow-t-lg border-t border-gray-200 z-10"><div className="flex justify-around max-w-4xl mx-auto">{navItems.map(item => (<button key={item.id} onClick={() => setCurrentPage(item.id)} className={`flex flex-col items-center justify-center w-full pt-3 pb-2 text-sm font-medium transition-colors ${currentPage === item.id ? 'text-red-600' : 'text-gray-500 hover:text-red-500'}`}><item.icon className={`w-6 h-6 mb-1`} />{item.label}</button>))}</div></nav>); 
        }
        const POST_TYPES = { CME: { label: "CME Topic", icon: BookOpen, points: 5 }, CASE: { label: "Case Discussion", icon: FileText, points: 10 }, PUBLICATION: { label: "Publication", icon: BrainCircuit, points: 1 }, CME_EVENT: { label: "CME Event", icon: Calendar, points: 0, adminOnly: true },};
        
        function Feed({ user, userData }) {
            const [posts, setPosts] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [showCreateModal, setShowCreateModal] = useState(false);
            useEffect(() => { const q = query(collection(db, "posts")); const unsubscribe = onSnapshot(q, (querySnapshot) => { const postsData = []; querySnapshot.forEach((doc) => postsData.push({ id: doc.id, ...doc.data() })); postsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); setPosts(postsData); setIsLoading(false); }, (err) => { console.error("Feed Error:", err); setIsLoading(false); }); return () => unsubscribe(); }, []);
            return (<div><div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold">Activity Feed</h2><button onClick={() => setShowCreateModal(true)} className="flex items-center bg-red-600 text-white font-semibold py-2 px-4 rounded-full shadow hover:bg-red-700 transition-colors"><PlusCircle className="w-5 h-5 mr-2" /> Share</button></div>{isLoading && <p>Loading feed...</p>}{!isLoading && posts.length === 0 && <div className="text-center p-8 text-gray-500">No posts in the feed yet. Be the first to share!</div>}<div className="space-y-4">{posts.map(post => <PostCard key={post.id} post={post} user={user} userData={userData}/>)}</div>{showCreateModal && <CreatePostModal user={user} userData={userData} onClose={() => setShowCreateModal(false)} />}</div>);
        }

        function PostCard({ post, user, userData }) { 
            const PostIcon = POST_TYPES[post.type]?.icon || BrainCircuit;
            const timeAgo = (timestamp) => { if (!timestamp) return 'just now'; const postDate = timestamp.toDate(); const seconds = Math.floor((new Date() - postDate) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + "y ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + "d ago"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + "h ago"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + "m ago"; return "just now"; };
            return (<div className="bg-white rounded-xl shadow-md overflow-hidden"><div className="p-5"><div className="flex items-start justify-between"><div><div className={`flex items-center text-sm font-semibold ${post.authorIsAdmin ? 'text-purple-600' : 'text-red-600'} mb-2`}><PostIcon className="w-5 h-5 mr-2" /><span>{POST_TYPES[post.type]?.label || 'Share'}</span>{post.authorIsAdmin && <span className="ml-2 text-xs bg-purple-100 text-purple-800 font-bold px-2 py-0.5 rounded-full">ADMIN</span>}</div><h4 className="text-lg font-bold text-gray-900">{post.title}</h4></div><div className="text-sm text-gray-400 whitespace-nowrap pl-2">{timeAgo(post.createdAt)}</div></div>{post.content && <p className="mt-2 text-gray-700">{post.content}</p>}{post.type === "CME_EVENT" ? <CMEEventCard post={post} user={user} userData={userData} /> : (post.link && <a href={post.link} target="_blank" rel="noopener noreferrer" className="mt-3 inline-flex items-center text-red-600 hover:text-red-800 font-semibold text-sm">View Resource <ExternalLink className="w-4 h-4 ml-1" /></a>)}<div className="mt-4 pt-3 border-t border-gray-200"><p className="text-sm text-gray-500">Shared by <span className="font-semibold">{post.authorName}</span> ({post.authorProfession})</p></div></div></div>);
        }
        
        function CMEEventCard({ post, user, userData }) {
            const [registrations, setRegistrations] = useState([]);
            const [userStatus, setUserStatus] = useState('unregistered');
            const [showRegModal, setShowRegModal] = useState(false);
            
            useEffect(() => {
                const regsColRef = collection(db, "posts", post.id, "registrations");
                const unsubscribe = onSnapshot(regsColRef, (snapshot) => {
                    const regsData = [];
                    let foundUser = false;
                    snapshot.forEach(regDoc => { const data = regDoc.data(); regsData.push({ ...data, id: regDoc.id }); if(regDoc.id === user.uid) { setUserStatus(data.status); foundUser = true; } });
                    setRegistrations(regsData);
                    if(!foundUser) setUserStatus('unregistered');
                });
                return () => unsubscribe();
            }, [post.id, user.uid]);

            const handleApprove = async (regId, regName) => {
                const regDocRef = doc(db, "posts", post.id, "registrations", regId);
                const userDocRef = doc(db, "users", regId);
                const pointsHistoryColRef = collection(db, "users", regId, "points_history");
                const batch = writeBatch(db);
                batch.update(regDocRef, { status: 'approved' });
                batch.update(userDocRef, { points: increment(1) });
                batch.set(doc(pointsHistoryColRef), { points: 1, reason: `CME Event: ${post.title}`, createdAt: serverTimestamp() });
                await batch.commit();
            };

            return (
                <div className="mt-4">
                     <div className="mt-3 space-y-2"><div className="flex items-center"><Users className="w-5 h-5 mr-2 text-gray-500" /><p><span className="font-semibold">Target Peserta: </span>{(post.targetProfessions || []).join(', ')}</p></div><div className="flex items-center"><Star className="w-5 h-5 mr-2 text-yellow-500" /><p><span className="font-semibold">SKP: </span>{post.skpPoints || 0}</p></div></div>
                     {post.link && <a href={post.link} target="_blank" rel="noopener noreferrer" className="mt-3 inline-flex items-center text-green-600 hover:text-green-800 font-semibold text-sm">View on Kemenkes LMS<ExternalLink className="w-4 h-4 ml-1" /></a>}
                    
                    {userData.isAdmin ? (
                        <div className="mt-4 p-3 bg-gray-50 rounded-lg">
                            <h4 className="font-bold text-lg mb-2">Registrations ({registrations.length})</h4>
                            {registrations.length === 0 && <p className="text-sm text-gray-500">No registrations yet.</p>}
                            <ul className="space-y-2 max-h-48 overflow-y-auto">{registrations.map(reg => (
                                <li key={reg.id} className="flex justify-between items-center bg-white p-2 rounded shadow-sm">
                                    <div><p className="font-semibold">{reg.fullName}</p><p className="text-sm text-gray-500">NIK: {reg.nik}</p></div>
                                    {reg.status === 'pending' ? <button onClick={() => handleApprove(reg.id)} className="bg-green-500 text-white px-3 py-1 text-sm rounded-full hover:bg-green-600">Approve</button> : <span className="text-sm font-bold text-green-600 flex items-center"><CheckCircle className="w-4 h-4 mr-1"/>Approved</span>}
                                </li>
                            ))}</ul>
                        </div>
                    ) : (
                        <>
                            <button onClick={() => setShowRegModal(true)} disabled={userStatus !== 'unregistered'} className="w-full mt-4 font-bold py-2 px-4 rounded-lg transition-colors bg-red-600 text-white hover:bg-red-700 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed">
                                {userStatus === 'unregistered' && 'Register for 1 Point'}
                                {userStatus === 'pending' && 'Registration Pending'}
                                {userStatus === 'approved' && 'Registered & Approved'}
                            </button>
                            {showRegModal && <CMERegistrationModal post={post} user={user} userData={userData} onClose={() => setShowRegModal(false)} />}
                        </>
                    )}
                </div>
            );
        }

        function CMERegistrationModal({ post, user, userData, onClose }) {
            const [fullName, setFullName] = useState(userData.displayName || '');
            const [nik, setNik] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!fullName.trim() || !nik.trim()) return;
                setIsSubmitting(true);
                const regDocRef = doc(db, "posts", post.id, "registrations", user.uid);
                await setDoc(regDocRef, { status: 'pending', fullName, nik, registeredAt: serverTimestamp() });
                setIsSubmitting(false);
                onClose();
            };

            return (
                 <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
                        <form onSubmit={handleSubmit}>
                            <div className="p-6">
                                <h3 className="text-xl font-bold mb-1">Register for CME</h3>
                                <p className="text-gray-600 mb-4">{post.title}</p>
                                <div className="space-y-4">
                                    <div><label className="block text-sm font-medium">Full Name</label><input type="text" value={fullName} onChange={e => setFullName(e.target.value)} className="w-full p-2 rounded-lg border" required /></div>
                                    <div><label className="block text-sm font-medium">NIK (National ID)</label><input type="text" value={nik} onChange={e => setNik(e.target.value)} className="w-full p-2 rounded-lg border" required /></div>
                                </div>
                            </div>
                            <div className="bg-gray-50 px-6 py-4 flex justify-end space-x-3"><button type="button" onClick={onClose} className="bg-gray-200 px-4 py-2 rounded-lg">Cancel</button><button type="submit" disabled={isSubmitting} className="bg-red-600 text-white px-4 py-2 rounded-lg disabled:bg-red-300">Submit Registration</button></div>
                        </form>
                    </div>
                </div>
            );
        }

        function CreatePostModal({ user, userData, onClose }) {
            const [type, setType] = useState(userData.isAdmin ? 'CME_EVENT' : 'CME');
            const [title, setTitle] = useState('');
            const [link, setLink] = useState('');
            const [content, setContent] = useState('');
            const [skpPoints, setSkpPoints] = useState(0);
            const [targetProfessions, setTargetProfessions] = useState([]);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const availablePostTypes = Object.keys(POST_TYPES).filter(key => !POST_TYPES[key].adminOnly || userData.isAdmin);
            const handleProfessionChange = (e) => { const options = e.target.options; const value = []; for (let i = 0, l = options.length; i < l; i++) { if (options[i].selected) { value.push(options[i].value); } } setTargetProfessions(value); };
            const handleSubmit = async () => {
                if (!title.trim()) return;
                setIsSubmitting(true);
                const postData = { type, title, link, content, authorId: user.uid, authorName: userData.displayName, authorProfession: userData.profession, createdAt: serverTimestamp(), authorIsAdmin: userData.isAdmin };
                if (type === "CME_EVENT") { postData.skpPoints = Number(skpPoints); postData.targetProfessions = targetProfessions; }
                try {
                    const postRef = await addDoc(collection(db, "posts"), postData);
                    const points = POST_TYPES[type]?.points || 0;
                    if (points > 0) {
                         const userDocRef = doc(db, "users", user.uid);
                         const pointsHistoryRef = collection(db, "users", user.uid, "points_history");
                         const batch = writeBatch(db);
                         batch.update(userDocRef, { points: increment(points) });
                         batch.set(doc(pointsHistoryRef), { points, reason: `Shared a ${type}`, createdAt: serverTimestamp() });
                         await batch.commit();
                    }
                } catch (e) { console.error("Error posting:", e); }
                setIsSubmitting(false);
                onClose();
            };
            return (<div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-lg"><div className="p-6"><h3 className="text-xl font-bold mb-4">Share with the Academy</h3><div className="space-y-4"><div><label className="block text-sm font-medium">Type</label><select value={type} onChange={e => setType(e.target.value)} className="w-full bg-gray-50 p-2 rounded-lg border">{availablePostTypes.map(key => (<option key={key} value={key}>{POST_TYPES[key].label}</option>))}</select></div><div><label className="block text-sm font-medium">Title</label><input type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-2 rounded-lg border" /></div>{type === "CME_EVENT" && <><div><label className="block text-sm font-medium">SKP Points</label><input type="number" value={skpPoints} onChange={e => setSkpPoints(e.target.value)} className="w-full p-2 rounded-lg border" /></div><div><label className="block text-sm font-medium">Target Peserta</label><select multiple={true} value={targetProfessions} onChange={handleProfessionChange} className="w-full h-32 bg-gray-50 p-2 rounded-lg border">{PROFESSIONS.map(p => <option key={p} value={p}>{p}</option>)}</select></div></>}<div><label className="block text-sm font-medium">Description</label><textarea value={content} onChange={e => setContent(e.target.value)} rows="4" className="w-full p-2 rounded-lg border"></textarea></div><div><label className="block text-sm font-medium">Link</label><input type="url" value={link} onChange={e => setLink(e.target.value)} className="w-full p-2 rounded-lg border" /></div></div></div><div className="bg-gray-50 px-6 py-4 flex justify-end space-x-3"><button onClick={onClose} className="bg-gray-200 px-4 py-2 rounded-lg">Cancel</button><button onClick={handleSubmit} disabled={isSubmitting} className="bg-red-600 text-white px-4 py-2 rounded-lg disabled:bg-red-300">Share</button></div></div></div>);
        }
        function Discussions({ user, userData }) {
            const [topics, setTopics] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [selectedTopic, setSelectedTopic] = useState(null);
            const [showCreateModal, setShowCreateModal] = useState(false);
            useEffect(() => { const q = query(collection(db, "discussions"), where("professionGroup", "==", userData.profession)); const unsubscribe = onSnapshot(q, (querySnapshot) => { const topicsData = []; querySnapshot.forEach((doc) => topicsData.push({ id: doc.id, ...doc.data() })); topicsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); setTopics(topicsData); setIsLoading(false); }, (err) => { console.error("Discussions Error:", err); setIsLoading(false); }); return () => unsubscribe(); }, [userData.profession]);
            
            if (selectedTopic) { return <DiscussionTopicView topic={selectedTopic} user={user} userData={userData} onBack={() => setSelectedTopic(null)} /> }

            return (<div><div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold">Discussions for {userData.profession}s</h2><button onClick={() => setShowCreateModal(true)} className="flex items-center bg-red-600 text-white font-semibold py-2 px-4 rounded-full shadow hover:bg-red-700 transition-colors"><PlusCircle className="w-5 h-5 mr-2" /> Start Topic</button></div>{isLoading && <p>Loading discussions...</p>}{!isLoading && topics.length === 0 && <div className="text-center p-8 text-gray-500">No topics for your profession yet.</div>}<div className="space-y-3">{topics.map(topic => <div key={topic.id} onClick={() => setSelectedTopic(topic)} className="bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-md"><h3 className="font-bold text-lg">{topic.title}</h3><p className="text-sm text-gray-500">Started by {topic.authorName}</p></div>)}</div>{showCreateModal && <CreateDiscussionModal user={user} userData={userData} onClose={() => setShowCreateModal(false)} />}</div>);
        }
        function DiscussionTopicView({ topic, user, userData, onBack }) {
            const [replies, setReplies] = useState([]);
            const [newReply, setNewReply] = useState("");
            useEffect(() => { const q = query(collection(db, "discussions", topic.id, "replies")); const unsubscribe = onSnapshot(q, (snapshot) => { const repliesData = []; snapshot.forEach(doc => repliesData.push(doc.data())); repliesData.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)); setReplies(repliesData); }); return () => unsubscribe(); }, [topic.id]);
            const handleReply = async (e) => { e.preventDefault(); if (!newReply.trim()) return; await addDoc(collection(db, "discussions", topic.id, "replies"), { text: newReply, authorName: userData.displayName, authorId: user.uid, createdAt: serverTimestamp() }); setNewReply(""); };
            return (<div className="pb-20"><button onClick={onBack} className="flex items-center text-red-600 font-semibold mb-4"><ChevronLeft className="w-5 h-5 mr-1" />Back to Discussions</button><div className="bg-white p-4 rounded-lg shadow-md mb-4"><h2 className="text-xl font-bold">{topic.title}</h2><p className="text-sm text-gray-600">Started by {topic.authorName}</p></div><div className="space-y-3 mb-4">{replies.map((reply, i) => (<div key={i} className="bg-white p-3 rounded-lg shadow-sm"><p className="text-gray-800">{reply.text}</p><p className="text-xs text-gray-500 mt-2 font-medium">- {reply.authorName}</p></div>))}</div><form onSubmit={handleReply} className="bg-white p-3 rounded-lg shadow"><textarea value={newReply} onChange={(e) => setNewReply(e.target.value)} placeholder="Write your reply..." className="w-full border-gray-200 border rounded-md p-2" rows="3"></textarea><button type="submit" className="w-full mt-2 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Post Reply</button></form></div>);
        }
        function CreateDiscussionModal({user, userData, onClose}) {
             const [title, setTitle] = useState('');
             const [isSubmitting, setIsSubmitting] = useState(false);
             const handleSubmit = async () => { if (!title.trim()) return; setIsSubmitting(true); const discussionData = { title, authorId: user.uid, authorName: userData.displayName, professionGroup: userData.profession, createdAt: serverTimestamp() }; const userDocRef = doc(db, "users", user.uid); const pointsHistoryRef = collection(db, "users", user.uid, "points_history"); const batch = writeBatch(db); batch.set(doc(collection(db, "discussions")), discussionData); batch.update(userDocRef, { points: increment(1) }); batch.set(doc(pointsHistoryRef), { points: 1, reason: `Started discussion: ${title}`, createdAt: serverTimestamp() }); await batch.commit(); setIsSubmitting(false); onClose(); };
             return (<div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-lg"><div className="p-6"><h3 className="text-xl font-bold mb-4">Start a New Discussion</h3><div><label className="block text-sm font-medium">Title</label><input type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-2 rounded-lg border" /></div></div><div className="bg-gray-50 px-6 py-4 flex justify-end space-x-3"><button onClick={onClose} className="bg-gray-200 px-4 py-2 rounded-lg">Cancel</button><button onClick={handleSubmit} disabled={isSubmitting} className="bg-red-600 text-white px-4 py-2 rounded-lg disabled:bg-red-300">Start Topic</button></div></div></div>);
        }
        function Leaderboard() {
             const [users, setUsers] = useState([]);
             useEffect(() => { const q = query(collection(db, "users")); const unsubscribe = onSnapshot(q, (snapshot) => { const usersData = []; snapshot.forEach(doc => usersData.push(doc.data())); usersData.sort((a,b) => b.points - a.points); setUsers(usersData); }); return () => unsubscribe(); }, []);
             return (<div className="pb-20"><h2 className="text-2xl font-bold mb-4">Leaderboard</h2><div className="bg-white rounded-xl shadow-md overflow-hidden"><ul className="divide-y divide-gray-200">{users.map((u, index) => (<li key={u.uid} className="p-4 flex items-center justify-between"><div className="flex items-center"><span className={`font-bold text-lg w-10 text-center ${index < 3 ? 'text-yellow-500' : 'text-gray-500'}`}>{index + 1}</span><div className="ml-4"><p className="font-semibold text-gray-800">{u.displayName}</p><p className="text-sm text-gray-500">{u.profession}</p></div></div><div className="flex items-center font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full"><Star className="w-4 h-4 mr-1 text-yellow-400" />{u.points}</div></li>))}</ul></div></div>);
        }
        function PointsHistory({user}) {
             const [history, setHistory] = useState([]);
             useEffect(() => { const q = query(collection(db, "users", user.uid, "points_history")); const unsubscribe = onSnapshot(q, (snapshot) => { const historyData = []; snapshot.forEach(doc => historyData.push(doc.data())); historyData.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); setHistory(historyData); }); return () => unsubscribe(); }, [user.uid]);
             return (<div className="pb-20"><h2 className="text-2xl font-bold mb-4">My Points History</h2><div className="bg-white rounded-xl shadow-md overflow-hidden"><ul className="divide-y divide-gray-200">{history.length === 0 && <p className="p-4 text-center text-gray-500">No points awarded yet.</p>}{history.map((item, index) => (<li key={index} className="p-4 flex items-center justify-between"><div className="flex-grow"><p className="font-semibold text-gray-800">{item.reason}</p><p className="text-sm text-gray-500">{(new Date(item.createdAt?.seconds * 1000)).toLocaleDateString()}</p></div><div className="font-bold text-green-600 text-lg">+{item.points}</div></li>))}</ul></div></div>);
        }
        function Profile({ user, userData }) { return (<div className="pb-20"><h2 className="text-2xl font-bold mb-4">My Profile</h2><div className="bg-white rounded-xl shadow-lg p-6 text-center"><User className="w-20 h-20 mx-auto text-gray-300 bg-gray-100 rounded-full p-2 mb-4" /><h3 className="text-2xl font-bold">{userData.displayName}</h3><p className="text-gray-600">{userData.profession}</p>{userData.isAdmin && <p className="text-sm font-bold text-red-600 bg-red-100 rounded-full py-1 my-2">ADMINISTRATOR</p>}<div className="mt-4 flex items-center justify-center space-x-2 bg-yellow-100 text-yellow-800 px-4 py-2 rounded-full"><Award className="w-6 h-6" /><span className="text-xl font-bold">{userData.points} Points</span></div><div className="mt-6 text-xs text-gray-400 break-all"><p className="font-semibold">User ID:</p><p className="font-mono">{user.uid}</p></div><div className="mt-6 border-t pt-4"><button onClick={() => signOut(auth)} className="flex items-center justify-center w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-red-600 transition-colors"><LogOut className="w-5 h-5 mr-2" /> Logout</button></div></div></div>); }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
