<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halodoc Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, where, serverTimestamp, increment, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword,
            getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, where, serverTimestamp, increment, writeBatch, getDocs
        };
    </script>
    
    <!-- React Application -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { 
            initializeApp, getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword,
            getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, where, serverTimestamp, increment, writeBatch, getDocs
        } = window.firebase;

        // --- Icon Components (using inline SVG) ---
        const Icon = ({ children, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const AcademyLogo = ({className}) => (<svg className={className} viewBox="0 0 512 236" xmlns="http://www.w3.org/2000/svg"><rect width="512" height="236" fill="#e6005c"/><text x="50" y="100" fontFamily="Arial" fontSize="80" fill="white">halodoc</text><text x="50" y="180" fontFamily="Arial" fontSize="50" fill="white">academy</text><circle cx="30" cy="50" r="10" fill="white"/><rect x="20" y="60" width="20" height="80" fill="white"/><path d="M 20 140 Q 30 160 40 140" fill="none" stroke="white" strokeWidth="10"/></svg>);
        const Award = ({className}) => <Icon className={className}><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 17 17 23 15.79 13.88"></polyline></Icon>;
        const BookOpen = ({className}) => <Icon className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></Icon>;
        const MessageSquare = ({className}) => <Icon className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></Icon>;
        const User = ({className}) => <Icon className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></Icon>;
        const PlusCircle = ({className}) => <Icon className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></Icon>;
        const BrainCircuit = ({className}) => <Icon className={className}><path d="M12 2a2.5 2.5 0 0 1 3 4.5v0a3.5 3.5 0 0 1 4.2 6.3c.2.5.3 1.2.3 2.2a4 4 0 0 1-8 0c0-1 .1-1.7.3-2.2a3.5 3.5 0 0 1 4.2-6.3v0a2.5 2.5 0 0 1 3-4.5Z"></path><path d="M19.5 12c.3-1 .4-2.2.4-3.5a4.5 4.5 0 0 0-8.2-2.3"></path><path d="M4.5 12c-.3-1-.4-2.2-.4-3.5A4.5 4.5 0 0 1 8.3 6.2"></path><path d="M12 15.5a2.5 2.5 0 0 1 3 4.5v0a3.5 3.5 0 0 1 4.2 6.3c.2.5.3 1.2.3 2.2a4 4 0 0 1-8 0c0-1 .1-1.7.3-2.2a3.5 3.5 0 0 1 4.2-6.3v0a2.5 2.5 0 0 1 3-4.5Z"></path></Icon>;
        const FileText = ({className}) => <Icon className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></Icon>;
        const ExternalLink = ({className}) => <Icon className={className}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></Icon>;
        const Star = ({className}) => <Icon className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></Icon>;
        const ChevronLeft = ({className}) => <Icon className={className}><polyline points="15 18 9 12 15 6"></polyline></Icon>;
        const LogOut = ({className}) => <Icon className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></Icon>;
        const Calendar = ({className}) => <Icon className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></Icon>;
        const Users = ({className}) => <Icon className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></Icon>;
        const CheckCircle = ({className}) => <Icon className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></Icon>;
        const History = ({className}) => <Icon className={className}><path d="M3 3v18h18"></path><path d="M21 15L15 9l-4 4-4-4"></path></Icon>;
        const Bell = ({className}) => <Icon className={className}><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></Icon>;

        // --- CORRECTED: POST_TYPES defined at the top ---
        const POST_TYPES = { 
            CME: { label: "CME Topic", icon: BookOpen, points: 5 }, 
            CASE: { label: "Case Discussion", icon: FileText, points: 10 }, 
            PUBLICATION: { label: "Publication", icon: BrainCircuit, points: 1 }, 
            CME_EVENT: { label: "CME Event", icon: Calendar, points: 0, adminOnly: true },
        };

        // --- Firebase Configuration and Initialization ---
        const firebaseConfig = {
           apiKey: "AIzaSyARWTTU-w2QK6sn7SWBef2WFWPUM1SV-UI",
           authDomain: "halodoc-academy-app.firebaseapp.com",
           projectId: "halodoc-academy-app",
           storageBucket: "halodoc-academy-app.firebasestorage.app",
           messagingSenderId: "366488602096",
           appId: "1:366488602096:web:7b5b5b7893885c36ee4935",
           measurementId: "G-LJMRSDP7FG"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Admin Configuration ---
        const ADMIN_UID = "YtyygqKsn2dFn1LmiNJOS1TZYaJ3";
        const PROFESSIONS = ["Doctor", "Nurse", "Pharmacist", "Midwife", "Lab Technician", "Other"];
        
        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState('feed');
            
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
                    if (firebaseUser) {
                        setUser(firebaseUser);
                        const userDocRef = doc(db, "users", firebaseUser.uid);
                        const userDocSnap = await getDoc(userDocRef);
                        if (userDocSnap.exists()) {
                            setUserData({ ...userDocSnap.data(), isAdmin: firebaseUser.uid === ADMIN_UID });
                        } else {
                            setUserData(null);
                        }
                    } else {
                        setUser(null);
                        setUserData(null);
                    }
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (isLoading) { return <LoadingScreen />; }
            if (!user) { return <AuthScreen />; }
            if (user && !userData) { return <ProfileSetupScreen user={user} onProfileCreated={setUserData} />; }

            if (user && userData) {
                return (
                    <div className="container mx-auto max-w-4xl">
                        <Header user={user} userData={userData} />
                        <main className="p-4 pb-24">
                            {currentPage === 'feed' && <Feed user={user} userData={userData} />}
                            {currentPage === 'discussions' && <Discussions user={user} userData={userData} />}
                            {currentPage === 'leaderboard' && userData.isAdmin && <Leaderboard />}
                            {currentPage === 'points_history' && !userData.isAdmin && <PointsHistory user={user} />}
                            {currentPage === 'profile' && <Profile user={user} userData={userData} />}
                        </main>
                        <NavBar currentPage={currentPage} setCurrentPage={setCurrentPage} userData={userData}/>
                    </div>
                );
            }
            return <LoadingScreen message="Verifying connection..."/>;
        }

        function AuthScreen() {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');
                try { if (isLogin) { await signInWithEmailAndPassword(auth, email, password); } else { await createUserWithEmailAndPassword(auth, email, password); } } catch (err) { setError(err.message); } 
                finally { setIsLoading(false); }
            };
            return (<div className="min-h-screen flex items-center justify-center p-4"><div className="w-full max-w-md bg-white rounded-xl shadow-lg p-8"><div className="text-center mb-6"><AcademyLogo className="h-10 mx-auto" /></div><h2 className="text-xl font-bold text-center mb-4">{isLogin ? 'Login' : 'Register'}</h2>{error && <p className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">{error}</p>}<form onSubmit={handleSubmit} className="space-y-4"><div><label className="block text-sm font-medium">Email</label><input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full p-2 rounded-lg border" required /></div><div><label className="block text-sm font-medium">Password</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 rounded-lg border" required /></div><button type="submit" disabled={isLoading} className="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 disabled:bg-red-300">{isLoading ? 'Loading...' : (isLogin ? 'Login' : 'Register')}</button></form><div className="mt-4 text-center"><button onClick={() => setIsLogin(!isLogin)} className="text-sm text-red-600 hover:underline">{isLogin ? 'Need an account? Register' : 'Already have an account? Login'}</button></div></div></div>);
        }
        
        function LoadingScreen({ message = "Connecting to Halodoc Academy..." }) { return (<div className="flex flex-col items-center justify-center min-h-screen"><AcademyLogo className="h-16 animate-pulse" /><h1 className="mt-4 text-xl font-semibold text-red-700">{message}</h1></div>); }
        function ProfileSetupScreen({ user, onProfileCreated }) {
            const [displayName, setDisplayName] = useState('');
            const [profession, setProfession] = useState('');
            const [error, setError] = useState('');
            const [isSaving, setIsSaving] = useState(false);
            const handleSetup = async () => {
                if (!displayName.trim() || !profession) { setError("Please provide your name and select a profession."); return; }
                setIsSaving(true);
                const userProfile = { uid: user.uid, displayName, profession, points: 0, createdAt: serverTimestamp(), isAdmin: user.uid === ADMIN_UID };
                try { await setDoc(doc(db, "users", user.uid), userProfile); onProfileCreated({ ...userProfile, isAdmin: user.uid === ADMIN_UID }); } catch (err) { console.error("Error creating profile:", err); setError("Could not save profile. Please try again."); setIsSaving(false); }
            };
            return (<div className="min-h-screen flex items-center justify-center p-4"><div className="w-full max-w-md bg-white rounded-xl shadow-lg p-8"><div className="text-center mb-6"><BrainCircuit className="w-12 h-12 mx-auto text-red-500" /><h1 className="text-2xl font-bold text-gray-800 mt-2">Welcome to Halodoc Academy</h1><p className="text-gray-500">Let's set up your professional profile.</p></div>{error && <p className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">{error}</p>}<div className="space-y-6"><div><label htmlFor="displayName" className="block text-sm font-medium text-gray-700 mb-1">Full Name</label><input id="displayName" type="text" value={displayName} onChange={(e) => setDisplayName(e.target.value)} placeholder="e.g. Dr. Budi Santoso" className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" /></div><div><label htmlFor="profession" className="block text-sm font-medium text-gray-700 mb-1">Profession</label><select id="profession" value={profession} onChange={(e) => setProfession(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 bg-white"><option value="" disabled>Select your profession...</option>{PROFESSIONS.map(p => <option key={p} value={p}>{p}</option>)}</select></div></div><div className="mt-8"><button onClick={handleSetup} disabled={isSaving} className="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:bg-red-300 transition-colors">{isSaving ? "Saving..." : "Join Academy"}</button></div></div></div>);
        }
        function Header({ user, userData }) {
            const [showNotifications, setShowNotifications] = useState(false);
            const [notifications, setNotifications] = useState([]);
            useEffect(() => { if (!user) return; const q = query(collection(db, "users", user.uid, "notifications")); const unsubscribe = onSnapshot(q, (querySnapshot) => { const notifsData = []; querySnapshot.forEach((doc) => notifsData.push({ id: doc.id, ...doc.data() })); notifsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); setNotifications(notifsData); }); return () => unsubscribe(); }, [user]);
            return (<header className="bg-white shadow-sm sticky top-0 z-20 p-4 flex justify-between items-center"><div className="flex items-center space-x-3"><AcademyLogo className="h-8" /></div><div className="flex items-center space-x-4"><div className="relative"><button onClick={() => setShowNotifications(!showNotifications)} className="relative text-gray-500 hover:text-red-600"><Bell className="w-6 h-6" />{notifications.length > 0 && <span className="absolute -top-1 -right-1 flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span>}</button>{showNotifications && (<div className="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl overflow-hidden border"><div className="p-3 font-bold text-lg border-b">Notifications</div><ul className="max-h-96 overflow-y-auto">{notifications.length > 0 ? (notifications.map(notif => (<li key={notif.id} className="p-3 border-b hover:bg-gray-50"><p className="font-semibold text-gray-800">{notif.title}</p><p className="text-sm text-gray-600">{notif.message}</p></li>))) : (<li className="p-4 text-center text-gray-500">No new notifications.</li>)}</ul></div>)}</div></div></header>);
        }
        function NavBar({ currentPage, setCurrentPage, userData }) { 
            let navItems = [
                { id: 'feed', label: 'Feed', icon: BookOpen }, 
                { id: 'discussions', label: 'Discussions', icon: MessageSquare }, 
                { id: 'profile', label: 'Profile', icon: User }
            ];
            if (userData.isAdmin) {
                navItems.splice(2, 0, { id: 'leaderboard', label: 'Leaderboard', icon: Award });
            } else {
                navItems.splice(2, 0, { id: 'points_history', label: 'My Points', icon: History });
            }
            return (<nav className="fixed bottom-0 left-0 right-0 bg-white shadow-t-lg border-t border-gray-200 z-10"><div className="flex justify-around max-w-4xl mx-auto">{navItems.map(item => (<button key={item.id} onClick={() => setCurrentPage(item.id)} className={`flex flex-col items-center justify-center w-full pt-3 pb-2 text-sm font-medium transition-colors ${currentPage === item.id ? 'text-red-600' : 'text-gray-500 hover:text-red-500'}`}><item.icon className={`w-6 h-6 mb-1`} />{item.label}</button>))}</div></nav>); 
        }
        
        function Feed({ user, userData }) {
            const [posts, setPosts] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [showCreateModal, setShowCreateModal] = useState(false);
            useEffect(() => { const q = query(collection(db, "posts")); const unsubscribe = onSnapshot(q, (querySnapshot) => { const postsData = []; querySnapshot.forEach((doc) => postsData.push({ id: doc.id, ...doc.data() })); postsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); setPosts(postsData); setIsLoading(false); }, (err) => { console.error("Feed Error:", err); setIsLoading(false); }); return () => unsubscribe(); }, []);
            return (<div><div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold">Activity Feed</h2><button onClick={() => setShowCreateModal(true)} className="flex items-center bg-red-600 text-white font-semibold py-2 px-4 rounded-full shadow hover:bg-red-700 transition-colors"><PlusCircle className="w-5 h-5 mr-2" /> Share</button></div>{isLoading && <p>Loading feed...</p>}{!isLoading && posts.length === 0 && <div className="text-center p-8 text-gray-500">No posts in the feed yet. Be the first to share!</div>}<div className="space-y-4">{posts.map(post => <PostCard key={post.id} post={post} user={user} userData={userData}/>)}</div>{showCreateModal && <CreatePostModal user={user} userData={userData} onClose={() => setShowCreateModal(false)} />}</div>);
        }

        function PostCard({ post, user, userData }) { 
            const PostIcon = POST_TYPES[post.type]?.icon || BrainCircuit;
            const timeAgo = (timestamp) => { if (!timestamp) return 'just now'; const postDate = timestamp.toDate(); const seconds = Math.floor((new Date() - postDate) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + "y ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + "d ago"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + "h ago"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + "m ago"; return "just now"; };
            return (<div className="bg-white rounded-xl shadow-md overflow-hidden"><div className="p-5"><div className="flex items-start justify-between"><div><div className={`flex items-center text-sm font-semibold ${post.authorIsAdmin ? 'text-purple-600' : 'text-red-600'} mb-2`}><PostIcon className="w-5 h-5 mr-2" /><span>{POST_TYPES[post.type]?.label || 'Share'}</span>{post.authorIsAdmin && <span className="ml-2 text-xs bg-purple-100 text-purple-800 font-bold px-2 py-0.5 rounded-full">ADMIN</span>}</div><h4 className="text-lg font-bold text-gray-900">{post.title}</h4></div><div className="text-sm text-gray-400 whitespace-nowrap pl-2">{timeAgo(post.createdAt)}</div></div>{post.content && <p className="mt-2 text-gray-700">{post.content}</p>}{post.type === "CME_EVENT" ? <CMEEventCard post={post} user={user} userData={userData} /> : (post.link && <a href={post.link} target="_blank" rel="noopener noreferrer" className="mt-3 inline-flex items-center text-red-600 hover:text-red-800 font-semibold text-sm">View Resource <ExternalLink className="w-4 h-4 ml-1" /></a>)}<div className="mt-4 pt-3 border-t border-gray-200"><p className="text-sm text-gray-500">Shared by <span className="font-semibold">{post.authorName}</span> ({post.authorProfession})</p></div></div></div>);
        }
        
        function CMEEventCard({ post, user, userData }) {
            const [registrations, setRegistrations] = useState([]);
            const [userStatus, setUserStatus] = useState('unregistered');
            const [showRegModal, setShowRegModal] = useState(false);
            
            useEffect(() => {
                const regsColRef = collection(db, "posts", post.id, "registrations");
                const unsubscribe = onSnapshot(regsColRef, (snapshot) => {
                    const regsData = [];
                    let foundUser = false;
                    snapshot.forEach(regDoc => { const data = regDoc.data(); regsData.push({ ...data, id: regDoc.id }); if(regDoc.id === user.uid) { setUserStatus(data.status); foundUser = true; } });
                    setRegistrations(regsData);
                    if(!foundUser) setUserStatus('unregistered');
                });
                return () => unsubscribe();
            }, [post.id, user.uid]);

            const handleApprove = async (regId, regName) => {
                const regDocRef = doc(db, "posts", post.id, "registrations", regId);
                const userDocRef = doc(db, "users", regId);
                const pointsHistoryColRef = collection(db, "users", regId, "points_history");
                const batch = writeBatch(db);
                batch.update(regDocRef, { status: 'approved' });
                batch.update(userDocRef, { points: increment(1) });
                batch.set(doc(pointsHistoryColRef), { points: 1, reason: `CME Event: ${post.title}`, createdAt: serverTimestamp() });
                await batch.commit();
            };

            return (
                <div className="mt-4">
                     <div className="mt-3 space-y-2"><div className="flex items-center"><Users className="w-5 h-5 mr-2 text-gray-500" /><p><span className="font-semibold">Target Peserta: </span>{(post.targetProfessions || []).join(', ')}</p></div><div className="flex items-center"><Star className="w-5 h-5 mr-2 text-yellow-500" /><p><span className="font-semibold">SKP: </span>{post.skpPoints || 0}</p></div></div>
                     {post.link && <a href={post.link} target="_blank" rel="noopener noreferrer" className="mt-3 inline-flex items-center text-green-600 hover:text-green-800 font-semibold text-sm">View on Kemenkes LMS<ExternalLink className="w-4 h-4 ml-1" /></a>}
                    
                    {userData.isAdmin ? (
                        <div className="mt-4 p-3 bg-gray-50 rounded-lg">
                            <h4 className="font-bold text-lg mb-2">Registrations ({registrations.length})</h4>
                            {registrations.length === 0 && <p className="text-sm text-gray-500">No registrations yet.</p>}
                            <ul className="space-y-2 max-h-48 overflow-y-auto">{registrations.map(reg => (
                                <li key={reg.id} className="flex justify-between items-center bg-white p-2 rounded shadow-sm">
                                    <div><p className="font-semibold">{reg.fullName}</p><p className="text-sm text-gray-500">NIK: {reg.nik}</p></div>
                                    {reg.status === 'pending' ? <button onClick={() => handleApprove(reg.id)} className="bg-green-500 text-white px-3 py-1 text-sm rounded-full hover:bg-green-600">Approve</button> : <span className="text-sm font-bold text-green-600 flex items-center"><CheckCircle className="w-4 h-4 mr-1"/>Approved</span>}
                                </li>
                            ))}</ul>
                        </div>
                    ) : (
                        <>
                            <button onClick={() => setShowRegModal(true)} disabled={userStatus !== 'unregistered'} className="w-full mt-4 font-bold py-2 px-4 rounded-lg transition-colors bg-red-600 text-white hover:bg-red-700 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed">
                                {userStatus === 'unregistered' && 'Register for 1 Point'}
                                {userStatus === 'pending' && 'Registration Pending'}
                                {userStatus === 'approved' && 'Registered & Approved'}
                            </button>
                            {showRegModal && <CMERegistrationModal post={post} user={user} userData={userData} onClose={() => setShowRegModal(false)} />}
                        </>
                    )}
                </div>
            );
        }

        function CMERegistrationModal({ post, user, userData, onClose }) {
            const [fullName, setFullName] = useState(userData.displayName || '');
            const [nik, setNik] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!fullName.trim() || !nik.trim()) return;
                setIsSubmitting(true);
                const regDocRef = doc(db, "posts", post.id, "registrations", user.uid);
                await setDoc(regDocRef, { status: 'pending', fullName, nik, registeredAt: serverTimestamp() });
                setIsSubmitting(false);
                onClose();
            };

            return (
                 <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
                        <form onSubmit={handleSubmit}>
                            <div className="p-6">
                                <h3 className="text-xl font-bold mb-1">Register for CME</h3>
                                <p className="text-gray-600 mb-4">{post.title}</p>
                                <div className="space-y-4">
                                    <div><label className="block text-sm font-medium">Full Name</label><input type="text" value={fullName} onChange={e => setFullName(e.target.value)} className="w-full p-2 rounded-lg border" required /></div>
                                    <div><label className="block text-sm font-medium">NIK (National ID)</label><input type="text" value={nik} onChange={e => setNik(e.target.value)} className="w-full p-2 rounded-lg border" required /></div>
                                </div>
                            </div>
                            <div className="bg-gray-50 px-6 py-4 flex justify-end space-x-3"><button type="button" onClick={onClose} className="bg-gray-200 px-4 py-2 rounded-lg">Cancel</button><button type="submit" disabled={isSubmitting} className="bg-red-600 text-white px-4 py-2 rounded-lg disabled:bg-red-300">Submit Registration</button></div>
                        </form>
                    </div>
                </div>
            );
        }

        function CreatePostModal({ user, userData, onClose }) {
            const [type, setType] = useState(userData.isAdmin ? 'CME_EVENT' : 'CME');
            const [title, setTitle] = useState('');
            const [link, setLink] = useState('');
            const [content, setContent] = useState('');
            const [skpPoints, setSkpPoints] = useState(0);
            const [targetProfessions, setTargetProfessions] = useState([]);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const availablePostTypes = Object.keys(POST_TYPES).filter(key => !POST_TYPES[key].adminOnly || userData.isAdmin);
            const handleProfessionChange = (e) => { const options = e.target.options; const value = []; for (let i = 0, l = options.length; i < l; i++) { if (options[i].selected) { value.push(options[i].value); } } setTargetProfessions(value); };
            const handleSubmit = async () => {
                if (!title.trim()) return;
                setIsSubmitting(true);
                const postData = { type, title, link, content, authorId: user.uid, authorName: userData.displayName, authorProfession: userData.profession, createdAt: serverTimestamp(), authorIsAdmin: userData.isAdmin };
                if (type === "CME_EVENT") { postData.skpPoints = Number(skpPoints); postData.targetProfessions = targetProfessions; }
                try {
                    const postRef = await addDoc(collection(db, "posts"), postData);
                    const points = POST_TYPES[type]?.points || 0;
                    if (points > 0) {
                         const userDocRef = doc(db, "users", user.uid);
                         const pointsHistoryRef = collection(db, "users", user.uid, "points_history");
                         const batch = writeBatch(db);
                         batch.update(userDocRef, { points: increment(points) });
                         batch.set(doc(pointsHistoryRef), { points, reason: `Shared a ${type}`, createdAt: serverTimestamp() });
                         await batch.commit();
                    }
                } catch (e) { console.error("Error posting:", e); }
                setIsSubmitting(false);
                onClose();
            };
            return (<div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-lg"><div className="p-6"><h3 className="text-xl font-bold mb-4">Share with the Academy</h3><div className="space-y-4"><div><label className="block text-sm font-medium">Type</label><select value={type} onChange={e => setType(e.target.value)} className="w-full bg-gray-50 p-2 rounded-lg border">{availablePostTypes.map(key => (<option key={key} value={key}>{POST_TYPES[key].label}</option>))}</select></div><div><label className="block text-sm font-medium">Title</label><input type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-2 rounded-lg border" /></div>{type === "CME_EVENT" && <><div><label className="block text-sm font-medium">SKP Points</label><input type="number" value={skpPoints} onChange={e => setSkpPoints(e.target.value)} className="w-full p-2 rounded-lg border" /></div><div><label className="block text-sm font-medium">Target Peserta</label><select multiple={true} value={targetProfessions} onChange={handleProfessionChange} className="w-full h-32 bg-gray-50 p-2 rounded-lg border">{PROFESSIONS.map(p => <option key={p} value={p}>{p}</option>)}</select></div></>}<div><label className="block text-sm font-medium">Description</label><textarea value={content} onChange={e => setContent(e.target.value)} rows="4" className="w-full p-2 rounded-lg border"></textarea></div><div><label className="block text-sm font-medium">Link</label><input type="url" value={link} onChange={e => setLink(e.target.value)} className="w-full p-2 rounded-lg border" /></div></div></div><div className="bg-gray-50 px-6 py-4 flex justify-end space-x-3"><button onClick={onClose} className="bg-gray-200 px-4 py-2 rounded-lg">Cancel</button><button onClick={handleSubmit} disabled={isSubmitting} className="bg-red-600 text-white px-4 py-2 rounded-lg disabled:bg-red-300">Share</button></div></div></div>);
        }
        function Discussions({ user, userData }) {
            const [topics, setTopics] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [selectedTopic, setSelectedTopic] = useState(null);
            const [showCreateModal, setShowCreateModal] = useState(false);
            useEffect(() => { const q = query(collection(db, "discussions"), where("professionGroup", "==", userData.profession)); const unsubscribe = onSnapshot(q, (querySnapshot) => { const topicsData = []; querySnapshot.forEach((doc) => topicsData.push({ id: doc.id, ...doc.data() })); topicsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); setTopics(topicsData); setIsLoading(false); }, (err) => { console.error("Discussions Error:", err); setIsLoading(false); }); return () => unsubscribe(); }, [userData.profession]);
            
            if (selectedTopic) { return <DiscussionTopicView topic={selectedTopic} user={user} userData={userData} onBack={() => setSelectedTopic(null)} /> }

            return (<div><div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold">Discussions for {userData.profession}s</h2><button onClick={() => setShowCreateModal(true)} className="flex items-center bg-red-600 text-white font-semibold py-2 px-4 rounded-full shadow hover:bg-red-700 transition-colors"><PlusCircle className="w-5 h-5 mr-2" /> Start Topic</button></div>{isLoading && <p>Loading discussions...</p>}{!isLoading && topics.length === 0 && <div className="text-center p-8 text-gray-500">No topics for your profession yet.</div>}<div className="space-y-3">{topics.map(topic => <div key={topic.id} onClick={() => setSelectedTopic(topic)} className="bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-md"><h3 className="font-bold text-lg">{topic.title}</h3><p className="text-sm text-gray-500">Started by {topic.authorName}</p></div>)}</div>{showCreateModal && <CreateDiscussionModal user={user} userData={userData} onClose={() => setShowCreateModal(false)} />}</div>);
        }
        function DiscussionTopicView({ topic, user, userData, onBack }) {
            const [replies, setReplies] = useState([]);
            const [newReply, setNewReply] = useState("");
            useEffect(() => { const q = query(collection(db, "discussions", topic.id, "replies")); const unsubscribe = onSnapshot(q, (snapshot) => { const repliesData = []; snapshot.forEach(doc => repliesData.push(doc.data())); repliesData.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)); setReplies(repliesData); }); return () => unsubscribe(); }, [topic.id]);
            const handleReply = async (e) => { e.preventDefault(); if (!newReply.trim()) return; await addDoc(collection(db, "discussions", topic.id, "replies"), { text: newReply, authorName: userData.displayName, authorId: user.uid, createdAt: serverTimestamp() }); setNewReply(""); };
            return (<div className="pb-20"><button onClick={onBack} className="flex items-center text-red-600 font-semibold mb-4"><ChevronLeft className="w-5 h-5 mr-1" />Back to Discussions</button><div className="bg-white p-4 rounded-lg shadow-md mb-4"><h2 className="text-xl font-bold">{topic.title}</h2><p className="text-sm text-gray-600">Started by {topic.authorName}</p></div><div className="space-y-3 mb-4">{replies.map((reply, i) => (<div key={i} className="bg-white p-3 rounded-lg shadow-sm"><p className="text-gray-800">{reply.text}</p><p className="text-xs text-gray-500 mt-2 font-medium">- {reply.authorName}</p></div>))}</div><form onSubmit={handleReply} className="bg-white p-3 rounded-lg shadow"><textarea value={newReply} onChange={(e) => setNewReply(e.target.value)} placeholder="Write your reply..." className="w-full border-gray-200 border rounded-md p-2" rows="3"></textarea><button type="submit" className="w-full mt-2 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Post Reply</button></form></div>);
        }
        function CreateDiscussionModal({user, userData, onClose}) {
             const [title, setTitle] = useState('');
             const [isSubmitting, setIsSubmitting] = useState(false);
             const handleSubmit = async () => { if (!title.trim()) return; setIsSubmitting(true); const discussionData = { title, authorId: user.uid, authorName: userData.displayName, professionGroup: userData.profession, createdAt: serverTimestamp() }; const userDocRef = doc(db, "users", user.uid); const pointsHistoryRef = collection(db, "users", user.uid, "points_history"); const batch = writeBatch(db); batch.set(doc(collection(db, "discussions")), discussionData); batch.update(userDocRef, { points: increment(1) }); batch.set(doc(pointsHistoryRef), { points: 1, reason: `Started discussion: ${title}`, createdAt: serverTimestamp() }); await batch.commit(); setIsSubmitting(false); onClose(); };
             return (<div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-lg"><div className="p-6"><h3 className="text-xl font-bold mb-4">Start a New Discussion</h3><div><label className="block text-sm font-medium">Title</label><input type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-2 rounded-lg border" /></div></div><div className="bg-gray-50 px-6 py-4 flex justify-end space-x-3"><button onClick={onClose} className="bg-gray-200 px-4 py-2 rounded-lg">Cancel</button><button onClick={handleSubmit} disabled={isSubmitting} className="bg-red-600 text-white px-4 py-2 rounded-lg disabled:bg-red-300">Start Topic</button></div></div></div>);
        }
        function Leaderboard() {
             const [users, setUsers] = useState([]);
             useEffect(() => { const q = query(collection(db, "users")); const unsubscribe = onSnapshot(q, (snapshot) => { const usersData = []; snapshot.forEach(doc => usersData.push(doc.data())); usersData.sort((a,b) => b.points - a.points); setUsers(usersData); }); return () => unsubscribe(); }, []);
             return (<div className="pb-20"><h2 className="text-2xl font-bold mb-4">Leaderboard</h2><div className="bg-white rounded-xl shadow-md overflow-hidden"><ul className="divide-y divide-gray-200">{users.map((u, index) => (<li key={u.uid} className="p-4 flex items-center justify-between"><div className="flex items-center"><span className={`font-bold text-lg w-10 text-center ${index < 3 ? 'text-yellow-500' : 'text-gray-500'}`}>{index + 1}</span><div className="ml-4"><p className="font-semibold text-gray-800">{u.displayName}</p><p className="text-sm text-gray-500">{u.profession}</p></div></div><div className="flex items-center font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full"><Star className="w-4 h-4 mr-1 text-yellow-400" />{u.points}</div></li>))}</ul></div></div>);
        }
        function PointsHistory({user}) {
             const [history, setHistory] = useState([]);
             useEffect(() => { const q = query(collection(db, "users", user.uid, "points_history")); const unsubscribe = onSnapshot(q, (snapshot) => { const historyData = []; snapshot.forEach(doc => historyData.push(doc.data())); historyData.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); setHistory(historyData); }); return () => unsubscribe(); }, [user.uid]);
             return (<div className="pb-20"><h2 className="text-2xl font-bold mb-4">My Points History</h2><div className="bg-white rounded-xl shadow-md overflow-hidden"><ul className="divide-y divide-gray-200">{history.length === 0 && <p className="p-4 text-center text-gray-500">No points awarded yet.</p>}{history.map((item, index) => (<li key={index} className="p-4 flex items-center justify-between"><div className="flex-grow"><p className="font-semibold text-gray-800">{item.reason}</p><p className="text-sm text-gray-500">{(new Date(item.createdAt?.seconds * 1000)).toLocaleDateString()}</p></div><div className="font-bold text-green-600 text-lg">+{item.points}</div></li>))}</ul></div></div>);
        }
        function Profile({ user, userData }) { return (<div className="pb-20"><h2 className="text-2xl font-bold mb-4">My Profile</h2><div className="bg-white rounded-xl shadow-lg p-6 text-center"><User className="w-20 h-20 mx-auto text-gray-300 bg-gray-100 rounded-full p-2 mb-4" /><h3 className="text-2xl font-bold">{userData.displayName}</h3><p className="text-gray-600">{userData.profession}</p>{userData.isAdmin && <p className="text-sm font-bold text-red-600 bg-red-100 rounded-full py-1 my-2">ADMINISTRATOR</p>}<div className="mt-4 flex items-center justify-center space-x-2 bg-yellow-100 text-yellow-800 px-4 py-2 rounded-full"><Award className="w-6 h-6" /><span className="text-xl font-bold">{userData.points} Points</span></div><div className="mt-6 text-xs text-gray-400 break-all"><p className="font-semibold">User ID:</p><p className="font-mono">{user.uid}</p></div><div className="mt-6 border-t pt-4"><button onClick={() => signOut(auth)} className="flex items-center justify-center w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-red-600 transition-colors"><LogOut className="w-5 h-5 mr-2" /> Logout</button></div></div></div>); }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
